<!DOCTYPE html>
<html>
<head>
    <title>Defect Workflow</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",projectOid:23112780161,tagOid:21580021389,tagRef:"/tag/21580021389",numberOfMonths:5,intervals:[],store:null,cvOpenedDateFilter:[],cvInProgressDateFilter:[],cvAcceptedDateFilter:[],unkownToHaveCVtag:[],verifiedToHaveCVtag:[],counter:0,totalAssigned:[],assigned:[],totalOpened:[],opened:[],totalInProgress:[],inProgress:[],totalAccepted:[],accepted:[],data:[],launch:function(){this.getDates(),this.prepare(),this.createInitialFilters(),this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait.This may take long depending on your data..."}),this._myMask.show()},getDates:function(){var now=new Date,firstDayOfThisMonth=new Date(now.getFullYear(),now.getMonth(),1);Date.prototype.calcFullMonths=function(monthOffset){var d=new Date(firstDayOfThisMonth);return d.setMonth(d.getMonth()-monthOffset),d};for(var howFarBack=(new Date).calcFullMonths(this.numberOfMonths),m=1;this.numberOfMonths>=m;m++){var firstDayOfNextMonth=new Date(howFarBack.getFullYear(),howFarBack.getMonth()+1,1);this.intervals.push({from:Rally.util.DateTime.format(howFarBack,"Y-m-d"),to:Rally.util.DateTime.format(firstDayOfNextMonth,"Y-m-d"),month:howFarBack.toLocaleString("en-us",{month:"long"})}),howFarBack=firstDayOfNextMonth}},prepare:function(){for(i=0;this.intervals.length>i;i++)this.opened.push([]),this.inProgress.push([]),this.accepted.push([]),this.assigned.push([])},createInitialFilters:function(){var tagFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Tags",operator:"contains",value:this.tagRef}),openedDateFilter=Rally.data.wsapi.Filter.and([{property:"OpenedDate",operator:">=",value:_.first(this.intervals).from},{property:"OpenedDate",operator:"<",value:_.last(this.intervals).to}]);this.cvOpenedDateFilter.push(tagFilter.and(openedDateFilter));var inProgressDateFilter=Rally.data.wsapi.Filter.and([{property:"InProgressDate",operator:">=",value:_.first(this.intervals).from},{property:"InProgressDate",operator:"<",value:_.last(this.intervals).to}]);this.cvInProgressDateFilter.push(tagFilter.and(inProgressDateFilter));var acceptedDateFilter=Rally.data.wsapi.Filter.and([{property:"AcceptedDate",operator:">=",value:_.first(this.intervals).from},{property:"AcceptedDate",operator:"<",value:_.last(this.intervals).to}]);this.cvAcceptedDateFilter.push(tagFilter.and(acceptedDateFilter)),console.log(""+this.cvOpenedDateFilter),console.log(""+this.cvInProgressDateFilter),console.log(""+this.cvAcceptedDateFilter),this.makeStore(),this.applyOpenedFiltersToStore()},makeStore:function(){var store=Ext.create("Rally.data.wsapi.Store",{model:"Defect",fetch:["ObjectID","FormattedID","ScheduleState","State","CreationDate","OpenedDate","ClosedDate","InProgressDate","AcceptedDate"],limit:1/0,sorters:[{property:"ObjectID",order:"DESC"}]});return store},applyOpenedFiltersToStore:function(){var store=this.makeStore();store.addFilter(this.cvOpenedDateFilter),store.load({scope:this,callback:function(records,operation){operation.wasSuccessful()?(_.each(records,function(record){this.totalOpened.push(this.makeDefectObject(record))},this),this.onOpenedStoreLoaded()):console.log("oh,noes!")}})},onOpenedStoreLoaded:function(){console.log("this.totalOpened",this.totalOpened.length);var n=this.intervals.length;_.each(this.totalOpened,function(record){for(var i=0;n>i;i++)record.OpenedDate>=this.intervals[i].from&&record.OpenedDate<this.intervals[i].to&&this.opened[i].push(record)},this),this.applyInProgressFiltersToStore()},applyInProgressFiltersToStore:function(){var store=this.makeStore();store.addFilter(this.cvInProgressDateFilter),store.load({scope:this,callback:function(records,operation){operation.wasSuccessful()?(_.each(records,function(record){this.totalInProgress.push(this.makeDefectObject(record))},this),this.onInProgressStoreLoaded()):console.log("oh,noes!")}})},onInProgressStoreLoaded:function(){console.log("this.totalInProgress",this.totalInProgress.length),this.applyAcceptedFiltersToStore()},applyAcceptedFiltersToStore:function(){var store=this.makeStore();store.addFilter(this.cvAcceptedDateFilter),store.load({scope:this,callback:function(records,operation){operation.wasSuccessful()?(_.each(records,function(record){this.totalAccepted.push(this.makeDefectObject(record))},this),this.onAcceptedStoreLoaded()):console.log("oh,noes!")}})},onAcceptedStoreLoaded:function(){console.log("this.totalAccepted",this.totalAccepted.length);var n=this.intervals.length;_.each(this.totalAccepted,function(record){for(var i=0;n>i;i++)record.AcceptedDate>=this.intervals[i].from&&record.AcceptedDate<this.intervals[i].to&&this.accepted[i].push(record)},this),this.getDefectsAssignedToTeam()},getDefectsAssignedToTeam:function(){Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["ObjectID","_ValidFrom","_ValidTo","FormattedID","Project","_PreviousValues.Project","Tags","OpenedDate","InProgressDate","CreationDate"],find:{_TypeHierarchy:"Defect",_ProjectHierarchy:this.projectOid,"_PreviousValues.Project":{$ne:null},_ValidFrom:{$gte:this.intervals[0].from,$lt:this.intervals[this.intervals.length-1].to}},hydrate:["Project","_PreviousValues.Project"],listeners:{load:this.onSnapshotsLoaded,scope:this}}).load({params:{compress:!0,removeUnauthorizedSnapshots:!0}})},onSnapshotsLoaded:function(store,records){var arrSize=0;if(_.each(records,function(record){record.data.Tags.length>0?this.checkTagOid(record.data.Tags)&&this.totalAssigned.push(this.makeSnapshotObject(record.data)):this.unkownToHaveCVtag.push(record.data)},this),arrSize=this.unkownToHaveCVtag.length,arrSize>0){this.counter=arrSize;for(var i=this.counter-1;i>=0;i--)this.verify(this.unkownToHaveCVtag[i].ObjectID)}},checkTagOid:function(tags){var isThere=_.some(tags,function(tag){return tag===this.tagOid},this);return isThere},verify:function(oid){Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["ObjectID","FormattedID","Project","Tags","OpenedDate","CreationDate"],find:{ObjectID:oid,_TypeHierarchy:"Defect",_ProjectHierarchy:this.projectOid,__At:"current"},hydrate:["Project"]}).load({callback:function(records,operation,success){records[0]&&records[0].data.Tags.length>0&&this.checkTagOid(records[0].data.Tags)&&this.verifiedToHaveCVtag.push(records[0].data.ObjectID),this.counter--,0===this.counter&&this.onAssignedDefectsLoaded()},scope:this,params:{compress:!0,removeUnauthorizedSnapshots:!0}})},onAssignedDefectsLoaded:function(){_.mixin({findByValues:function(collection,property,values){return _.filter(collection,function(item){return _.contains(values,item[property])})}});var filtered=_.findByValues(this.unkownToHaveCVtag,"ObjectID",this.verifiedToHaveCVtag);_.each(filtered,function(snapshot){this.totalAssigned.push(this.makeSnapshotObject(snapshot))},this),this.getCurrentInProgressDates();var after=0;_.each(this.totalAssigned,function(assignedRecord){""===assignedRecord.InProgressDate&&after++});var n=this.intervals.length;_.each(this.totalAssigned,function(snapshot){for(var i=0;n>i;i++)snapshot.AssignedDate>=this.intervals[i].from&&snapshot.AssignedDate<this.intervals[i].to&&this.assigned[i].push(snapshot),""!==snapshot.InProgressDate&&snapshot.InProgressDate>=this.intervals[i].from&&snapshot.InProgressDate<this.intervals[i].to&&this.inProgress[i].push(snapshot)},this),this.collectRecords()},getCurrentInProgressDates:function(){_.each(this.totalAssigned,function(assignedRecord){_.each(this.totalInProgress,function(inProgressRecord){assignedRecord.ObjectID===inProgressRecord.ObjectID&&""===assignedRecord.InProgressDate&&(assignedRecord.InProgressDate=inProgressRecord.InProgressDate)},this)},this)},collectRecords:function(){for(var n=this.intervals.length,i=0;n>i;i++)this.processDefectsPerInterval(this.opened[i],i,"Opened"),this.processDefectsPerInterval(this.assigned[i],i,"Assigned"),this.processDefectsPerInterval(this.inProgress[i],i,"In-Progress"),this.processDefectsPerInterval(this.accepted[i],i,"Accepted");this.sortData()},makeDefectObject:function(record){return{_ref:record.get("_ref"),ObjectID:record.get("ObjectID"),FormattedID:record.get("FormattedID"),ScheduleState:record.get("ScheduleState"),State:record.get("State"),CreationDate:Rally.util.DateTime.toIsoString(record.get("CreationDate"),!1),OpenedDate:Rally.util.DateTime.toIsoString(record.get("OpenedDate"),!1),ClosedDate:Rally.util.DateTime.toIsoString(record.get("ClosedDate"),!1),InProgressDate:Rally.util.DateTime.toIsoString(record.get("InProgressDate"),!1),AcceptedDate:Rally.util.DateTime.toIsoString(record.get("AcceptedDate"),!1)}},makeSnapshotObject:function(record){return{AssignedDate:record._ValidFrom,Project:record.Project.Name,ObjectID:record.ObjectID,OpenedDate:record.OpenedDate,InProgressDate:record.InProgressDate,CreationDate:record.CreationDate,FormattedID:record.FormattedID}},processDefectsPerInterval:function(defectsPerInterval,counter,event){console.log(event,counter,defectsPerInterval.length);var previousEvent="",start="",end="",alternativeStart="CreationDate",order=0,interval=this.intervals[counter].month,chunksOfTime=[],min=0,max=0,mean=0;"Opened"===event?(start="CreationDate",end="OpenedDate",previousEvent="Created",order=1):"Assigned"===event?(start="OpenedDate",end="AssignedDate",previousEvent="Opened",order=2):"In-Progress"===event?(start="AssignedDate",end="InProgressDate",previousEvent="Assigned",order=3):"Accepted"===event&&(start="InProgressDate",end="AcceptedDate",previousEvent="InProgress",order=4),_.each(defectsPerInterval,function(defect){""===defect[start]&&(defect[start]=defect[alternativeStart]),chunksOfTime.push(this.getDiffInHours(defect[start],defect[end]))},this);var sum=0;_.each(chunksOfTime,function(t){sum=parseFloat((sum+parseFloat(t)).toFixed(2))}),mean=parseFloat((sum/chunksOfTime.length).toFixed(2)),max=Math.max.apply(Math,chunksOfTime),this.data.push({order:order,interval:interval,from:previousEvent,to:event,count:chunksOfTime.length,mean:mean,max:max})},getDiffInHours:function(isoString1,isoString2){var d1=new Date(isoString1),d2=new Date(isoString2);return(Math.abs(d2-d1)/36e5).toFixed(2)},sortData:function(){this.data=_.sortBy(this.data,function(d){return[d.order]}),this.makeGrid()},makeGrid:function(){this._myMask.hide(),this.add({xtype:"rallygrid",itemId:"dataGrid",showPagingToolbar:!1,editable:!1,store:Ext.create("Rally.data.custom.Store",{data:this.data}),columnCfgs:[{text:"Interval",dataIndex:"interval"},{text:"From",dataIndex:"from"},{text:"To",dataIndex:"to"},{text:"Count",dataIndex:"count"},{text:"Time Between Events (Mean)",dataIndex:"mean"},{text:"Time Between Events (Max)",dataIndex:"max"}]})}});

            Rally.launchApp('CustomApp', {
                name:"Defect Workflow",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app .rally-grid .x-grid-row:nth-child(5n+5) .x-grid-cell{border-bottom:double}
    </style>
</head>
<body>
</body>
</html>
